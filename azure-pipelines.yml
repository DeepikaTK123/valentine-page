trigger:
  - main

pool:
  vmImage: ubuntu-latest

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildApp
    displayName: Build Backend and Frontend
    steps:

    - checkout: self
      clean: true

    # ---------------- BACKEND ----------------
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'
      displayName: 'Use Python 3.10'

    - script: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install backend dependencies'

    # ---------------- FRONTEND ----------------
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Use Node.js 20'

    - script: |
        rm -rf frontend/node_modules
        rm -f frontend/package-lock.json
      displayName: 'Clean old frontend artifacts'

    - script: |
        cd frontend
        npm install
      displayName: 'Install frontend dependencies'

    - script: |
        cd frontend
        npm run build
      displayName: 'Build Vite React app'

    # ---------------- DEPLOY FRONTEND ----------------
    - task: AzureStaticWebApp@0
      displayName: 'Deploy Frontend to Azure Static Web App'
      inputs:
        app_location: "frontend"
        output_location: "dist"
        azure_static_web_apps_api_token: $(STATIC_WEB_APP_TOKEN)
