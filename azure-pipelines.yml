trigger:
  - main

pool:
  vmImage: ubuntu-latest

stages:
# =========================================================
# BUILD STAGE
# =========================================================
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildApp
    displayName: Build Backend and Frontend
    steps:

    # Clean checkout
    - checkout: self
      clean: true

    # ---------------- BACKEND BUILD ----------------
    - task: UsePythonVersion@0
      displayName: 'Use Python 3.10'
      inputs:
        versionSpec: '3.10'

    - script: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install backend dependencies'

    # ---------------- FRONTEND BUILD ----------------
    - task: NodeTool@0
      displayName: 'Use Node.js 20'
      inputs:
        versionSpec: '20.x'

    - script: |
        rm -rf frontend/node_modules
        rm -f frontend/package-lock.json
      displayName: 'Clean frontend artifacts'

    - script: |
        cd frontend
        npm install
      displayName: 'Install frontend dependencies'

    - script: |
        cd frontend
        npm run build
      displayName: 'Build Vite React app'

    # ---------------- DEPLOY FRONTEND ----------------
    - task: AzureStaticWebApp@0
      displayName: 'Deploy Frontend to Azure Static Web App'
      inputs:
        app_location: "frontend"
        output_location: "dist"
        azure_static_web_apps_api_token: $(STATIC_WEB_APP_TOKEN)

# =========================================================
# DEPLOY BACKEND STAGE
# =========================================================
- stage: Deploy_Backend
  displayName: Deploy Backend Stage
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployBackend
    displayName: Deploy Flask Backend
    steps:
    - task: AzureWebApp@1
      displayName: 'Deploy Backend to Azure App Service'
      inputs:
        azureSubscription: 'azure-service-connection'
        appName: 'pricepredictor-backendd'
        package: 'backend'
