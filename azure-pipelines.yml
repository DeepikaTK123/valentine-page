trigger:
  - main

pool:
  vmImage: ubuntu-latest

stages:
- stage: Build
  displayName: Build Stage
  jobs:
  - job: BuildApp
    displayName: Build Backend and Frontend
    steps:

    # ðŸ”¥ FORCE CLEAN CHECKOUT
    - checkout: self
      clean: true

    # ---------------- BACKEND ----------------
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'
      displayName: 'Use Python 3.10'

    - script: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
      displayName: 'Install backend dependencies'

    # ---------------- FRONTEND (VITE ONLY) ----------------
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Use Node.js 20'

    # ðŸ”¥ DELETE ANY OLD CRA ARTIFACTS
    - script: |
        rm -rf frontend/node_modules
        rm -f frontend/package-lock.json
      displayName: 'Clean old frontend artifacts'

    - script: |
        cd frontend
        npm install
      displayName: 'Install frontend dependencies'

    - script: |
        cd frontend
        npm run build
      displayName: 'Build Vite React app'
